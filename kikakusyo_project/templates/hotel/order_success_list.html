{% extends 'base.html' %}
{% block content %}
<div class="container">
    <h2>予約確定一覧表</h2>
    <table class="table">
        <thead>
            <tr>
                <th>予約番号</th>
                <th>ホテル名</th>
                {% comment %} <th>チェックイン日</th>
                <th>チェックアウト日</th> {% endcomment %}
                {% comment %} <th>合計金額</th>{% endcomment %}
                <th>詳細</th> 
                <th>キャンセル</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr>
                <td>{{ order.id }}</td>
                <td>{{ order.orderitems_set.first.product.hotel.name }}</td>
                {% comment %} <td>{{ order.orderitems_set.first.product.checkin }}</td>
                <td>{{ order.orderitems_set.first.product.checkout }}</td> {% endcomment %}
                {% comment %} <td>{{ order.total_price }}円</td> {% endcomment %}
                <td>
                <a href="{% url 'hotel:order_success_info' pk=order.id %}" class="btn btn-primary">詳細を見る</a>
                </td>
                <td>
                {% csrf_token %}
                <a href="{% url 'hotel:delete_order' pk=order.id %}" onclick="cancelReservation({{ order.id }}); return false;" class="btn btn-danger btn-sm">予約をキャンセル</a>
                <script>
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
                function deleteOrder(orderId) {
                    {% comment %} if (confirm('本当にこの予約をキャンセルしますか？')) { {% endcomment %}
                        const csrftoken = getCookie('csrftoken');
                        fetch(`/hotel/order/${orderId}/delete/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': csrftoken,
                                'Content-Type': 'application/json'
                            },
                            credentials: 'same-origin'
                        })
                        .then(response => {
                            if (!response.ok) {
                                {% comment %} return response.json().then(data => { {% endcomment %}
                                    throw new Error(data.message || 'キャンセル処理中にエラーが発生しました。');
                                });
                            }
                            return response.json();
                        })
                        .then(data => {
                            alert(data.message);
                            window.location.reload();
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            alert('キャンセル処理中にエラーが発生しました。');
                        });
                    }    
                }
                </script>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6">予約がありません。</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}